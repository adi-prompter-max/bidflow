---
phase: 05-ai-bid-generation
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/app/dashboard/tenders/[id]/bid/page.tsx
  - src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx
autonomous: false

must_haves:
  truths:
    - "Previously generated content loads on page revisit (not lost on refresh)"
    - "If bid already has generated sections, workspace opens in preview view showing them"
    - "User can regenerate from preview view, which overwrites existing generated content"
    - "Complete flow works end-to-end: start bid → answer questions → generate → preview → back to questions → regenerate"
    - "'Back to Questions' from preview restores Q&A at the user's last question position, not question 1"
  artifacts:
    - path: "src/app/dashboard/tenders/[id]/bid/page.tsx"
      provides: "Passes existing generated content to workspace component"
    - path: "src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx"
      provides: "Initializes view state based on existing generated content"
  key_links:
    - from: "src/app/dashboard/tenders/[id]/bid/page.tsx"
      to: "src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx"
      via: "initialGeneratedSections prop"
      pattern: "initialGeneratedSections"
---

<objective>
Wire generated content persistence into the page load flow and verify the complete end-to-end generation experience through visual checkpoint.

Purpose: Ensures generated bid content survives page refreshes and browser sessions. Without this, all generation work would be lost on navigation. Also validates the complete user flow works as expected.
Output: Updated page component passing persisted generated content, updated workspace detecting existing content, and verified end-to-end flow.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-bid-generation/05-RESEARCH.md
@.planning/phases/05-ai-bid-generation/05-01-SUMMARY.md
@.planning/phases/05-ai-bid-generation/05-02-SUMMARY.md

Files to modify:
@src/app/dashboard/tenders/[id]/bid/page.tsx
@src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire generated content persistence into page load and workspace initialization</name>
  <files>
    src/app/dashboard/tenders/[id]/bid/page.tsx
    src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx
  </files>
  <action>
    **Content Structure Specification (critical for understanding this task):**

    bid.content JSON has TWO possible shapes depending on lifecycle stage:

    1. **Pre-generation (flat answers):** When user is still in Q&A and has never generated:
       ```json
       { "company_overview": "...", "proposed_approach": "...", "timeline": "..." }
       ```
       This is a flat `Record<string, unknown>` — answer IDs as keys, answer values as values.

    2. **Post-generation (nested structure):** After generation completes (saved by saveGeneratedBid from Plan 05-01, and by content-aware auto-save from Plan 05-02):
       ```json
       {
         "answers": { "company_overview": "...", "proposed_approach": "...", "timeline": "..." },
         "sections": { "executive_summary": "...", "technical_approach": "...", ... },
         "generatedAt": "2026-02-07T12:00:00.000Z"
       }
       ```
       This is a `GeneratedBidContent` object — answers preserved alongside generated sections.

    **Detection rule:** If `bid.content` has a top-level `answers` key that is an object, it is post-generation format. Otherwise, it is pre-generation flat format.

    Modify `src/app/dashboard/tenders/[id]/bid/page.tsx`:
    - After loading bid.content, determine which format it is:
      ```
      const rawContent = bid.content as Record<string, unknown>
      const isPostGeneration = rawContent?.answers && typeof rawContent.answers === 'object' && !Array.isArray(rawContent.answers)
      const initialAnswers = isPostGeneration ? (rawContent.answers as Record<string, unknown>) : rawContent
      const initialGeneratedSections = isPostGeneration ? (rawContent.sections as Record<string, string> | undefined) : undefined
      const initialGeneratedAt = isPostGeneration ? (rawContent.generatedAt as string | undefined) : undefined
      ```
    - Pass `initialGeneratedSections` and `initialGeneratedAt` as new props to BidWorkspace

    Modify `src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx`:
    - Add to BidWorkspaceProps: `initialGeneratedSections?: Record<string, string>`, `initialGeneratedAt?: string`
    - Initialize `generatedSections` state with `initialGeneratedSections ?? {}`
    - Initialize `generatedAt` state with `initialGeneratedAt ?? null`
    - Initialize `view` state: if `initialGeneratedSections` has any keys (`Object.keys(initialGeneratedSections ?? {}).length > 0`), default to `'preview'`; otherwise default to `'questions'`
    - This ensures returning to a bid with generated content shows the preview
    - IMPORTANT: When "Back to Questions" is clicked (setting view to 'questions'), the existing Q&A startIndex / currentQuestionIndex state must be PRESERVED, not reset. The user resumes Q&A at their last position. Do NOT reset currentQuestionIndex to 0 when switching back — the existing state variable already holds the correct position.
    - Note: The content-aware auto-save logic (checking generatedSections before calling saveBidDraft) was already specified in Plan 05-02 Task 3 and does not need to be re-specified here. This task only adds the initialization from persisted data.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors. Verify page.tsx passes initialGeneratedSections prop. Verify bid-workspace.tsx accepts and uses the prop to initialize view state.
  </verify>
  <done>
    Generated bid content persists across page loads. Returning to a bid with generated sections shows preview view. Answers and generated sections coexist in bid.content JSON without overwriting each other.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete AI bid generation flow: Q&A completion → Generate Bid button → section-by-section streaming generation → preview of generated content → persistence across page refreshes.
  </what-built>
  <how-to-verify>
    1. Navigate to http://localhost:3000/dashboard/tenders
    2. Click on any tender, then click "Start Bid" or "Continue Bid"
    3. Answer all required questions in the Q&A workspace
    4. After all required questions are answered, look for the "Generate Professional Bid" section below the question card
    5. Click "Generate Bid" button
    6. Watch as each section generates with streaming text (should see 6 sections: Executive Summary, Technical Approach, Methodology, Timeline, Experience, Budget)
    7. Verify each section shows "Generating..." with streaming text, then transitions to "Complete"
    8. After all sections complete, verify you are in preview mode showing all generated content
    9. Click "Back to Questions" — verify you return to Q&A view
    10. Click "Generate Bid" again (if visible) or navigate back — verify regeneration works
    11. Refresh the page (F5) — verify generated content is preserved and preview view loads
    12. Check that the editorial design style is maintained (black borders, sharp corners, monochrome + yellow brand)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the generation flow</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Full flow works: answer questions → generate → preview → refresh preserves content
3. Generated sections have professional narrative content (not empty or placeholder)
4. Streaming text appears progressively with cursor animation
5. No console errors during generation or navigation
6. Page refresh loads previously generated content into preview view
</verification>

<success_criteria>
- Generated bid content survives page refresh
- Previously generated bids open in preview view
- Regeneration overwrites previous content correctly
- Complete end-to-end flow verified by user
- Editorial design style maintained throughout
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-bid-generation/05-03-SUMMARY.md`
</output>
