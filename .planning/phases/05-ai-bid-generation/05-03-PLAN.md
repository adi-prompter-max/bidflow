---
phase: 05-ai-bid-generation
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - src/app/dashboard/tenders/[id]/bid/page.tsx
  - src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx
autonomous: false

must_haves:
  truths:
    - "Previously generated content loads on page revisit (not lost on refresh)"
    - "If bid already has generated sections, workspace opens in preview view showing them"
    - "User can regenerate from preview view, which overwrites existing generated content"
    - "Complete flow works end-to-end: start bid → answer questions → generate → preview → back to questions → regenerate"
  artifacts:
    - path: "src/app/dashboard/tenders/[id]/bid/page.tsx"
      provides: "Passes existing generated content to workspace component"
    - path: "src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx"
      provides: "Initializes view state based on existing generated content"
  key_links:
    - from: "src/app/dashboard/tenders/[id]/bid/page.tsx"
      to: "src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx"
      via: "initialGeneratedSections prop"
      pattern: "initialGeneratedSections"
---

<objective>
Wire generated content persistence into the page load flow and verify the complete end-to-end generation experience through visual checkpoint.

Purpose: Ensures generated bid content survives page refreshes and browser sessions. Without this, all generation work would be lost on navigation. Also validates the complete user flow works as expected.
Output: Updated page component passing persisted generated content, updated workspace detecting existing content, and verified end-to-end flow.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-bid-generation/05-RESEARCH.md
@.planning/phases/05-ai-bid-generation/05-01-SUMMARY.md
@.planning/phases/05-ai-bid-generation/05-02-SUMMARY.md

Files to modify:
@src/app/dashboard/tenders/[id]/bid/page.tsx
@src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire generated content persistence into page load and workspace initialization</name>
  <files>
    src/app/dashboard/tenders/[id]/bid/page.tsx
    src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx
  </files>
  <action>
    Modify `src/app/dashboard/tenders/[id]/bid/page.tsx`:
    - After parsing bid.content as initialAnswers, also check if content has a `sections` property (indicating previously generated content)
    - Extract `initialGeneratedSections` from bid.content: if `(bid.content as any)?.sections` exists and is an object, pass it as a prop; otherwise pass undefined
    - Extract `initialAnswers` more carefully: if bid.content has an `answers` key, use that; otherwise use bid.content directly as answers (backward compatibility with pre-generation content structure where answers were stored flat)
    - Pass new prop `initialGeneratedSections` to BidWorkspace component

    Modify `src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx`:
    - Add `initialGeneratedSections?: Record<string, string>` to BidWorkspaceProps
    - Initialize `generatedSections` state with `initialGeneratedSections || {}`
    - Initialize `view` state: if initialGeneratedSections has any keys, default to 'preview'; otherwise default to 'questions'
    - This ensures that when a user returns to a bid with previously generated content, they see the generated preview instead of starting over
    - When saving answers during Q&A (in the auto-save flow), update the content structure to preserve existing generated sections: save as `{ answers: {...}, sections: existingGeneratedSections, generatedAt: existingTimestamp }` if sections exist, or just flat answers if no generation has happened yet
    - The onComplete callback in GenerationProgress should now also update the answers in the content to match the dual-storage pattern: `{ answers: currentAnswers, sections: generatedSections, generatedAt: new Date().toISOString() }`
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors. Verify page.tsx passes initialGeneratedSections prop. Verify bid-workspace.tsx accepts and uses the prop to initialize view state.
  </verify>
  <done>
    Generated bid content persists across page loads. Returning to a bid with generated sections shows preview view. Answers and generated sections coexist in bid.content JSON without overwriting each other.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete AI bid generation flow: Q&A completion → Generate Bid button → section-by-section streaming generation → preview of generated content → persistence across page refreshes.
  </what-built>
  <how-to-verify>
    1. Navigate to http://localhost:3000/dashboard/tenders
    2. Click on any tender, then click "Start Bid" or "Continue Bid"
    3. Answer all required questions in the Q&A workspace
    4. After all required questions are answered, look for the "Generate Professional Bid" section below the question card
    5. Click "Generate Bid" button
    6. Watch as each section generates with streaming text (should see 6 sections: Executive Summary, Technical Approach, Methodology, Timeline, Experience, Budget)
    7. Verify each section shows "Generating..." with streaming text, then transitions to "Complete"
    8. After all sections complete, verify you are in preview mode showing all generated content
    9. Click "Back to Questions" — verify you return to Q&A view
    10. Click "Generate Bid" again (if visible) or navigate back — verify regeneration works
    11. Refresh the page (F5) — verify generated content is preserved and preview view loads
    12. Check that the editorial design style is maintained (black borders, sharp corners, monochrome + yellow brand)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the generation flow</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Full flow works: answer questions → generate → preview → refresh preserves content
3. Generated sections have professional narrative content (not empty or placeholder)
4. Streaming text appears progressively with cursor animation
5. No console errors during generation or navigation
6. Page refresh loads previously generated content into preview view
</verification>

<success_criteria>
- Generated bid content survives page refresh
- Previously generated bids open in preview view
- Regeneration overwrites previous content correctly
- Complete end-to-end flow verified by user
- Editorial design style maintained throughout
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-bid-generation/05-03-SUMMARY.md`
</output>
