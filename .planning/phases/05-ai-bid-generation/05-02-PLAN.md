---
phase: 05-ai-bid-generation
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/dashboard/tenders/[id]/bid/components/generation-trigger.tsx
  - src/app/dashboard/tenders/[id]/bid/components/generation-progress.tsx
  - src/app/dashboard/tenders/[id]/bid/components/generated-section.tsx
  - src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a 'Generate Bid' button when all required Q&A questions are answered"
    - "Clicking Generate Bid starts section-by-section streaming generation"
    - "Each section shows its generation status: pending, generating (with streaming text), or complete"
    - "Generated text appears progressively with a cursor animation during streaming"
    - "User can see all 6 sections with their generation progress simultaneously"
    - "User can navigate away during generation without browser errors"
  artifacts:
    - path: "src/app/dashboard/tenders/[id]/bid/components/generation-trigger.tsx"
      provides: "Generate Bid button with completeness check"
      min_lines: 40
    - path: "src/app/dashboard/tenders/[id]/bid/components/generation-progress.tsx"
      provides: "Section-by-section generation orchestrator UI"
      min_lines: 80
    - path: "src/app/dashboard/tenders/[id]/bid/components/generated-section.tsx"
      provides: "Individual section display with streaming text"
      min_lines: 40
    - path: "src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx"
      provides: "Updated workspace with generation view toggle"
  key_links:
    - from: "src/app/dashboard/tenders/[id]/bid/components/generation-trigger.tsx"
      to: "src/lib/bids/validation.ts"
      via: "validateBidCompleteness import"
      pattern: "validateBidCompleteness"
    - from: "src/app/dashboard/tenders/[id]/bid/components/generation-progress.tsx"
      to: "src/lib/bids/mock-generator.ts"
      via: "generateBidSection import"
      pattern: "generateBidSection"
    - from: "src/app/dashboard/tenders/[id]/bid/components/generation-progress.tsx"
      to: "src/actions/bids.ts"
      via: "saveGeneratedBid import"
      pattern: "saveGeneratedBid"
    - from: "src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx"
      to: "src/actions/bids.ts"
      via: "saveBidDraft with content-aware structure"
      pattern: "saveBidDraft"
---

<objective>
Build the generation UI components: a trigger button that validates Q&A completeness, a progress orchestrator that generates sections sequentially with streaming text display, and integrate the generation view into the existing bid workspace.

Purpose: This plan creates the complete user-facing generation experience. After Q&A completion, users click "Generate Bid" and watch as each section streams professional narrative text in real-time. This is the core UX of Phase 5.
Output: Three new components and one modified workspace component providing the complete generation UI.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-bid-generation/05-RESEARCH.md
@.planning/phases/05-ai-bid-generation/05-01-SUMMARY.md

Existing workspace components to understand integration points:
@src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx
@src/app/dashboard/tenders/[id]/bid/page.tsx
@src/lib/bids/questions.ts
@src/lib/bids/validation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GenerationTrigger and GeneratedSection components</name>
  <files>
    src/app/dashboard/tenders/[id]/bid/components/generation-trigger.tsx
    src/app/dashboard/tenders/[id]/bid/components/generated-section.tsx
  </files>
  <action>
    Create `generation-trigger.tsx` ('use client'):
    - Props: { questions: Question[], answers: Record<string, unknown>, onGenerate: () => void, disabled?: boolean }
    - Import validateBidCompleteness from @/lib/bids/validation
    - Calculate completeness using validateBidCompleteness(answers, questions)
    - Render a styled container (border-2 border-black p-6 bg-white) with:
      - Heading: "Generate Professional Bid" (font-display text-xl)
      - Description text explaining the action
      - If not complete: show warning count of unanswered required questions (text-yellow-700)
      - Button using @/components/ui/button: disabled when !completeness.complete or disabled prop
      - Button shows Sparkles icon + "Generate Bid" text, or Loader2 spinner + "Generating..." when disabled
    - Use Sparkles and Loader2 from lucide-react

    Create `generated-section.tsx` ('use client'):
    - Props: { section: BidSection, content: string | undefined, status: 'pending' | 'generating' | 'complete' }
    - Import BidSection type from @/lib/bids/sections
    - Render a section container with border-2 border-black:
      - Header bar with section.title and status indicator:
        - pending: gray Circle icon + "Waiting..." text
        - generating: Loader2 spinner (animate-spin) + "Generating..." text
        - complete: CheckCircle2 icon (text-green-600) + "Complete" text
      - Content area:
        - pending: empty / minimal height placeholder
        - generating: show partial content + blinking cursor (animate-pulse "▋")
        - complete: show full content
    - Content rendered with whitespace-pre-wrap for markdown-like formatting
    - Use editorial design: sharp corners, strong borders, monochrome + check icon green
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors. Verify both component files exist and are properly formatted React client components with 'use client' directive.
  </verify>
  <done>
    Two UI components exist: trigger button with completeness validation and section display with three visual states (pending/generating/complete).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GenerationProgress orchestrator with proper stream cleanup</name>
  <files>
    src/app/dashboard/tenders/[id]/bid/components/generation-progress.tsx
  </files>
  <action>
    Create `generation-progress.tsx` ('use client'):
    - Props: { answers: Record<string, unknown>, tenderTitle: string, bidId: string, onComplete: (generatedContent: Record<string, string>) => void }
    - Import BID_SECTIONS, getAnswersForSection from @/lib/bids/sections
    - Import generateBidSection from @/lib/bids/mock-generator
    - Import saveGeneratedBid from @/actions/bids
    - Import GeneratedSection component
    - State: currentSectionIndex (number), generatedContent (Record<string, string>), sectionStatuses (Record<string, 'pending' | 'generating' | 'complete'>), isGenerating (boolean)
    - On mount (useEffect with empty deps), start generation sequence:
      1. Set isGenerating = true
      2. For each section in BID_SECTIONS sequentially:
        a. Set section status to 'generating'
        b. Get section answers via getAnswersForSection
        c. Call generateBidSection to get ReadableStream
        d. Get reader via stream.getReader()
        e. Read stream with reader, accumulate text, update generatedContent state on each chunk (triggers re-render showing streaming text)
        f. On stream complete: set section status to 'complete'
        g. In try/finally block: call reader.releaseLock()
        h. Check isMounted ref before state updates — skip if unmounted
        i. Move to next section
      3. After all sections complete: call saveGeneratedBid to persist, call onComplete with final generatedContent

    - CRITICAL STREAM CLEANUP: Use isMounted ref pattern combined with explicit reader cleanup:
      - Create `const isMounted = useRef(true)` and `const readerRef = useRef<ReadableStreamDefaultReader<string> | null>(null)`
      - Store current reader in readerRef before reading
      - In useEffect cleanup function:
        ```
        return () => {
          isMounted.current = false
          if (readerRef.current) {
            try {
              readerRef.current.cancel()
            } catch {
              // reader may already be released
            } finally {
              try { readerRef.current.releaseLock() } catch {}
            }
          }
        }
        ```
      - Before every setState call in the stream reading loop, check `if (!isMounted.current) return` to avoid state updates on unmounted component

    - Render: map over BID_SECTIONS, render GeneratedSection for each with current content and status
    - Show overall progress: "{completedCount}/{BID_SECTIONS.length} sections generated" text
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors. Verify generation-progress.tsx exists, is a 'use client' component, imports generateBidSection and saveGeneratedBid, and contains reader.cancel() and reader.releaseLock() calls in cleanup.
  </verify>
  <done>
    Generation progress orchestrator streams sections sequentially with ReadableStream consumption. Stream cleanup uses isMounted ref, reader.cancel(), and reader.releaseLock() in try/finally to prevent memory leaks and errors on unmount.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate generation view into bid workspace with content-aware auto-save</name>
  <files>
    src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx
  </files>
  <action>
    Modify `bid-workspace.tsx` to add a generation view alongside the existing Q&A view:

    1. Add state: `view` with type 'questions' | 'generating' | 'preview' (default: 'questions')
    2. Add state: `generatedSections` (Record<string, string>) to store generated content after completion

    3. After the existing "Submit for Review" button area, add the GenerationTrigger component:
      - Only show when view === 'questions' AND allRequiredAnswered is true
      - onGenerate handler: sets view to 'generating'
      - disabled when view !== 'questions'

    4. When view === 'generating':
      - Hide the QuestionCard and question navigation
      - Show GenerationProgress component instead
      - Pass answers, tender.title, bid.id, and onComplete callback
      - onComplete callback: stores generatedSections in state, sets view to 'preview'

    5. When view === 'preview':
      - Show all generated sections rendered with their content (simple display of generatedSections)
      - Show a "Back to Questions" button that sets view back to 'questions'
      - Show a "Regenerate" button that sets view to 'generating' and clears generatedSections

    6. CRITICAL — Content-aware auto-save to prevent overwriting generated sections:
      - When generatedSections state is non-empty (has keys), auto-save MUST construct the full content object:
        `{ answers: currentAnswers, sections: generatedSections, generatedAt: existingTimestamp }`
      - When generatedSections state is empty (no generation yet), auto-save sends flat answers as before (backward compatible)
      - Concretely: in the existing auto-save debounce handler, before calling saveBidDraft, check:
        ```
        const hasGenerated = Object.keys(generatedSections).length > 0
        const saveData = hasGenerated
          ? { answers: newAnswers, sections: generatedSections, generatedAt: generatedAt }
          : newAnswers
        saveBidDraft(bid.id, saveData)
        ```
      - Store `generatedAt` timestamp (string) in state alongside generatedSections — set it in the onComplete callback as `new Date().toISOString()`

    7. Keep all existing Q&A functionality (auto-save, navigation, progress) working when view === 'questions'
    8. Import GenerationTrigger and GenerationProgress from their respective files
    9. The existing Submit for Review button should remain visible in preview view (after generation is done)
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors. Verify bid-workspace.tsx imports GenerationTrigger and GenerationProgress correctly. Verify the view state toggles between 'questions', 'generating', and 'preview'. Verify auto-save logic constructs `{ answers, sections, generatedAt }` when generatedSections is non-empty.
  </verify>
  <done>
    Bid workspace now has three views: Q&A questions (existing), generating (streaming progress), and preview (showing generated content). Auto-save is content-aware: preserves generated sections when they exist, falls back to flat answers when no generation has happened. Users flow from answering questions → clicking Generate → watching generation → reviewing output.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. generation-trigger.tsx renders Generate Bid button with completeness validation
3. generated-section.tsx renders three visual states (pending/generating/complete) correctly
4. generation-progress.tsx orchestrates sequential section generation with streaming AND has explicit reader.cancel() + reader.releaseLock() in useEffect cleanup
5. bid-workspace.tsx has three-view state machine (questions → generating → preview)
6. bid-workspace.tsx auto-save constructs `{ answers, sections, generatedAt }` when generatedSections exist
7. All imports between new and existing files resolve correctly
</verification>

<success_criteria>
- User can see Generate Bid button after completing required Q&A questions
- Clicking Generate shows section-by-section streaming generation
- Each section transitions through pending → generating → complete states
- Generated content is saved to database via saveGeneratedBid
- User can view generated content in preview mode
- User can navigate back to questions or regenerate
- Navigating away during generation does not cause browser errors or memory leaks
- Auto-saving Q&A answers after generation preserves the generated sections in bid.content
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-bid-generation/05-02-SUMMARY.md`
</output>
