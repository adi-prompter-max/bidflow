---
phase: 05-ai-bid-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/bids/sections.ts
  - src/lib/bids/bid-templates.ts
  - src/lib/bids/mock-generator.ts
  - src/actions/bids.ts
autonomous: true

must_haves:
  truths:
    - "Tender requirements are mapped to 6 professional bid sections (Executive Summary, Technical Approach, Methodology, Timeline, Experience, Budget)"
    - "Q&A answers are extractable per bid section based on sourceQuestions mapping"
    - "Professional bid narrative templates produce realistic text from answer inputs"
    - "Mock streaming generator produces a ReadableStream with realistic timing (800ms initial delay, 80ms chunk delay)"
    - "Generated bid content can be persisted to database preserving both original answers and generated sections"
  artifacts:
    - path: "src/lib/bids/sections.ts"
      provides: "BidSection type, BID_SECTIONS array, getAnswersForSection helper"
      exports: ["BidSection", "BID_SECTIONS", "getAnswersForSection"]
    - path: "src/lib/bids/bid-templates.ts"
      provides: "Template functions for each of 6 bid sections"
      exports: ["BID_TEMPLATES", "expandTemplate", "TemplateContext"]
    - path: "src/lib/bids/mock-generator.ts"
      provides: "Mock AI streaming generator returning ReadableStream"
      exports: ["createMockStream", "generateBidSection", "GeneratorConfig"]
    - path: "src/actions/bids.ts"
      provides: "saveGeneratedBid server action for persisting generated content"
      exports: ["saveGeneratedBid", "GeneratedBidContent"]
  key_links:
    - from: "src/lib/bids/mock-generator.ts"
      to: "src/lib/bids/bid-templates.ts"
      via: "expandTemplate call"
      pattern: "expandTemplate\\("
    - from: "src/lib/bids/mock-generator.ts"
      to: "src/lib/bids/sections.ts"
      via: "section ID lookup"
      pattern: "BID_TEMPLATES\\["
    - from: "src/actions/bids.ts"
      to: "prisma.bid.update"
      via: "database persistence"
      pattern: "prisma\\.bid\\.update"
---

<objective>
Create the complete backend data layer for AI bid generation: bid section mapping from Q&A questions, professional narrative templates, mock streaming text generator, and server action for persisting generated content.

Purpose: Provides all the generation logic that the UI layer (Plan 02) will consume. Separating backend from UI ensures templates are testable, streaming logic is isolated, and persistence works independently.
Output: Four new/modified library files ready for UI consumption.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-bid-generation/05-RESEARCH.md
@.planning/phases/04-bid-workspace/04-01-SUMMARY.md

Existing bid library files to understand structure:
@src/lib/bids/questions.ts
@src/lib/bids/validation.ts
@src/actions/bids.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bid section mapping and professional narrative templates</name>
  <files>
    src/lib/bids/sections.ts
    src/lib/bids/bid-templates.ts
  </files>
  <action>
    Create `src/lib/bids/sections.ts`:
    - Define `BidSection` type with fields: id (string), title (string), order (number), sourceQuestions (string[] — IDs from questions.ts that feed this section), required (boolean).
    - Create `BID_SECTIONS` array with 6 sections in order:
      1. executive_summary (sources: company_overview, proposed_approach) — required
      2. technical_approach (sources: technical_approach, capability_match) — required
      3. methodology (sources: proposed_approach, deliverables_plan) — required
      4. timeline (sources: timeline) — required
      5. experience (sources: relevant_experience, certifications) — not required
      6. budget (sources: budget_notes) — not required
    - IMPORTANT: This mapping is STATIC and COMPLETE. It covers ALL question IDs from questions.ts:
      - 4 standard questions (always present): company_overview, proposed_approach, timeline, budget_notes
      - 5 dynamic questions (conditionally generated): capability_match, certifications, relevant_experience, technical_approach, deliverables_plan
      - Every dynamic question ID appears in at least one section's sourceQuestions array. No catch-all section is needed because the mapping is exhaustive.
    - Export `getAnswersForSection(section: BidSection, allAnswers: Record<string, unknown>): Record<string, unknown>` — extracts only the answers relevant to a given section by iterating over section.sourceQuestions. If a sourceQuestion ID is not present in allAnswers (because the dynamic question wasn't generated for this tender), it is simply skipped.

    Create `src/lib/bids/bid-templates.ts`:
    - Define `TemplateContext` type: { tenderTitle: string, companyName?: string, sector?: string }
    - Export `BID_TEMPLATES` as a Record<string, (answers: Record<string, unknown>, context: TemplateContext) => string> with template functions for all 6 sections.
    - Each template function takes answers and context, returns a professional markdown-formatted bid narrative (5-15 lines per section). Use the exact templates from 05-RESEARCH.md Pattern "Bid Section Templates".
    - Export `expandTemplate(template, answers, context): string` helper that calls template function.
    - Templates should gracefully handle missing answers with fallback professional text (not blank sections).
    - Templates use string interpolation with answers. No external template library.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors. Check that both files exist and export the expected symbols. Verify sections.ts exports BID_SECTIONS with 6 items, and bid-templates.ts exports BID_TEMPLATES with 6 keys matching section IDs.
  </verify>
  <done>
    6 bid sections defined with question-to-section mapping. 6 template functions producing professional bid narratives from Q&A answers. All types exported for downstream consumption.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create mock streaming generator and saveGeneratedBid server action</name>
  <files>
    src/lib/bids/mock-generator.ts
    src/actions/bids.ts
  </files>
  <action>
    Create `src/lib/bids/mock-generator.ts`:
    - Export `GeneratorConfig` type: { chunkDelayMs: number, initialDelayMs: number, wordsPerChunk: number }
    - Export `createMockStream(text: string, config?: GeneratorConfig): ReadableStream<string>` — splits text into word chunks of config.wordsPerChunk words each, returns a ReadableStream that:
      1. Waits config.initialDelayMs (default 800ms) before first chunk
      2. Enqueues each chunk with config.chunkDelayMs (default 80ms) delay between chunks
      3. Calls controller.close() after last chunk
    - Export `generateBidSection(sectionId: string, answers: Record<string, unknown>, tenderTitle: string, config?: GeneratorConfig): ReadableStream<string>` — looks up template from BID_TEMPLATES[sectionId], expands it with answers and { tenderTitle } context, then passes full text to createMockStream().
    - Use `new Promise(resolve => setTimeout(resolve, ms))` for delays. No external libraries.

    Extend `src/actions/bids.ts`:
    - Add `GeneratedBidContent` type: { answers: Record<string, unknown>, sections: Record<string, string>, generatedAt: string }
    - Add `saveGeneratedBid(bidId: string, generatedContent: GeneratedBidContent): Promise<ActionResult>` server action:
      1. Verify session and bid ownership (same pattern as saveBidDraft)
      2. Only allow saving for DRAFT or IN_REVIEW status bids
      3. Update bid content with generatedContent as Prisma.JsonObject
      4. Revalidate `/dashboard/tenders/${bid.tenderId}/bid` path
      5. Return { success: true } or { success: false, error: '...' }
    - Keep existing ActionResult type and existing actions (createBid, saveBidDraft, updateBidStatus) unchanged.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors. Verify mock-generator.ts exports createMockStream and generateBidSection. Verify bids.ts exports saveGeneratedBid and GeneratedBidContent type alongside existing exports.
  </verify>
  <done>
    Mock streaming generator produces ReadableStream with realistic timing. saveGeneratedBid server action persists both answers and generated sections to database. All existing bid actions remain functional.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `src/lib/bids/sections.ts` exists with BID_SECTIONS (6 items), getAnswersForSection export
3. `src/lib/bids/bid-templates.ts` exists with BID_TEMPLATES (6 keys), expandTemplate export
4. `src/lib/bids/mock-generator.ts` exists with createMockStream, generateBidSection exports
5. `src/actions/bids.ts` contains saveGeneratedBid, GeneratedBidContent alongside existing exports
6. No import errors between new files (mock-generator imports from bid-templates and sections)
</verification>

<success_criteria>
- All 4 bid library/action files exist and compile without errors
- Section mapping covers all question IDs from questions.ts
- Templates produce non-empty text for each section
- Mock generator returns ReadableStream type
- saveGeneratedBid preserves both answers and generated sections in content JSON
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-bid-generation/05-01-SUMMARY.md`
</output>
