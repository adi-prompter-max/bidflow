---
phase: 02-company-profiling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - prisma/seed.ts
  - src/lib/validations/profile.ts
autonomous: true

must_haves:
  truths:
    - "Company model supports multi-sector selection, sub-categories, capability description, and tags"
    - "Certification and Project are separate related models with proper cascade deletes"
    - "Zod schemas validate all five wizard steps with correct constraints"
    - "Required shadcn/ui components are installed and available"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Expanded Company model + Certification + Project models"
      contains: "model Certification"
    - path: "src/lib/validations/profile.ts"
      provides: "Zod schemas for all 5 wizard steps"
      exports: ["companyInfoSchema", "sectorsSchema", "capabilitiesSchema", "certificationSchema", "projectSchema"]
  key_links:
    - from: "prisma/schema.prisma"
      to: "Company model"
      via: "Certification and Project relations"
      pattern: "certifications\\s+Certification"
---

<objective>
Evolve the database schema to support comprehensive company profiles and create validation schemas for the 5-step wizard.

Purpose: The existing Company model is flat (single sector string, string arrays). Phase 2 needs multi-sector selection with sub-categories, separate Certification and Project tables, and expanded company fields (country, size, website). This plan creates the data foundation and validation layer that all subsequent profile plans depend on.

Output: Updated Prisma schema with migration applied, Zod validation schemas for each wizard step, and all necessary shadcn/ui components installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-company-profiling/02-CONTEXT.md
@.planning/phases/02-company-profiling/02-RESEARCH.md
@prisma/schema.prisma
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Evolve Prisma schema and run migration</name>
  <files>prisma/schema.prisma, prisma/seed.ts</files>
  <action>
    Update the Company model in prisma/schema.prisma to support the full profile wizard:

    **Company model changes:**
    - Keep existing fields: id, name, ownerId, owner relation, bids relation, createdAt, updatedAt
    - Change `sector` (String) to `sectors` (String[]) for multi-select
    - Add `sectorSubcategories` (Json?) for hierarchical sub-category storage (e.g., {"IT": ["Cloud Services", "Cybersecurity"], "Construction": ["Renovation"]})
    - Add `country` (String?) for company country
    - Add `size` (String?) for employee range (e.g., "1-10", "11-50", "51-200", "201-500", "500+")
    - Add `website` (String?) for company website URL
    - Rename `description` to keep as-is (already String? @db.Text) -- this serves as the brief company description (Step 1)
    - Add `capabilityDescription` (String? @db.Text) for the detailed capability free-text (Step 3, separate from company description)
    - Rename `capabilities` to `capabilityTags` (String[]) for capability tags (Step 3)
    - Remove `certifications` String[] field (replaced by Certification model)
    - Add `certifications` relation to Certification model
    - Add `projects` relation to Project model

    **New Certification model:**
    ```
    model Certification {
      id          String    @id @default(cuid())
      name        String
      issuingBody String
      issueDate   DateTime
      expiryDate  DateTime?
      companyId   String
      company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
      createdAt   DateTime  @default(now())
    }
    ```

    **New Project model:**
    ```
    model Project {
      id            String   @id @default(cuid())
      name          String
      clientName    String
      description   String   @db.Text
      sector        String
      valueRange    String
      yearCompleted Int
      companyId     String
      company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
      createdAt     DateTime @default(now())
    }
    ```

    After updating the schema, run `npx prisma db push` to apply changes (db push is fine for development -- avoids migration conflicts with existing data).

    Then update `prisma/seed.ts`:
    - Update the demo company to use new field names (`sectors: ["IT"]`, `capabilityTags` instead of `capabilities`, remove `certifications` string array)
    - Add `country: "United Kingdom"`, `size: "51-200"`, `website: "https://techbuild.example.com"`
    - Add `capabilityDescription` with a brief description of capabilities
    - Add `sectorSubcategories: { "IT": ["Cloud Services", "Cybersecurity", "Software Development"] }`
    - Create 2-3 sample Certification records for the demo company (ISO 27001, Cyber Essentials Plus, ISO 9001 with realistic dates)
    - Create 2 sample Project records for the demo company with realistic data

    Run `npx prisma db seed` to verify seed works.
    Run `npx prisma generate` to regenerate the client.
  </action>
  <verify>
    - `npx prisma db push` completes without errors
    - `npx prisma generate` completes without errors
    - `npx prisma db seed` runs successfully and logs created records
    - `npx prisma studio` (optional visual check) shows expanded Company, new Certification and Project tables
  </verify>
  <done>
    Company model has sectors[], sectorSubcategories, country, size, website, capabilityDescription, capabilityTags[], certifications relation, projects relation. Certification and Project models exist with proper Company relations and cascade deletes. Seed data includes demo certifications and projects.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validation schemas and install shadcn/ui components</name>
  <files>src/lib/validations/profile.ts</files>
  <action>
    **Part A: Install shadcn/ui components needed for the wizard.**

    Run `npx shadcn@latest add` for each of these components (existing: button, card, form, input, label):
    - `checkbox` (sector selection)
    - `textarea` (capability description, project description)
    - `dialog` (project add/edit modal)
    - `badge` (capability tags display)
    - `progress` (wizard progress bar)
    - `select` (company size, value range, sector dropdowns)
    - `table` (past projects table)
    - `separator` (visual separation in wizard steps)

    Use the `--yes` flag to skip prompts: `npx shadcn@latest add checkbox textarea dialog badge progress select table separator --yes`

    **Part B: Create Zod validation schemas.**

    Create `src/lib/validations/profile.ts` with schemas for each wizard step:

    ```typescript
    import { z } from 'zod'

    // Step 1: Company Info
    export const companyInfoSchema = z.object({
      name: z.string().min(2, 'Company name must be at least 2 characters').max(100),
      country: z.string().min(1, 'Country is required'),
      size: z.string().min(1, 'Company size is required'),
      website: z.string().url('Must be a valid URL').optional().or(z.literal('')),
      description: z.string().max(300, 'Description must be under 300 characters').optional().or(z.literal('')),
    })

    // Step 2: Industry Sectors
    // Sector sub-categories for IT and Construction
    export const IT_SUBCATEGORIES = [
      'Cloud Services',
      'Cybersecurity',
      'Software Development',
      'Data Analytics',
      'IT Consulting',
    ] as const

    export const CONSTRUCTION_SUBCATEGORIES = [
      'Renovation & Refurbishment',
      'New Build - Commercial',
      'New Build - Residential',
      'Infrastructure',
      'Demolition & Clearance',
    ] as const

    export const SECTORS = ['IT', 'Construction'] as const

    export const COMPANY_SIZES = [
      '1-10',
      '11-50',
      '51-200',
      '201-500',
      '500+',
    ] as const

    export const sectorsSchema = z.object({
      sectors: z.array(z.enum(SECTORS)).min(1, 'Select at least one sector'),
      sectorSubcategories: z.record(z.string(), z.array(z.string())).optional(),
    })

    // Step 3: Capabilities & Tags
    export const capabilitiesSchema = z.object({
      capabilityDescription: z.string().max(500, 'Description must be under 500 characters').optional().or(z.literal('')),
      capabilityTags: z.array(z.string().min(1)).max(30, 'Maximum 30 tags allowed'),
    })

    // Step 4: Certifications (single certification for add/edit)
    export const certificationSchema = z.object({
      name: z.string().min(1, 'Certification name is required').max(100),
      issuingBody: z.string().min(1, 'Issuing body is required').max(100),
      issueDate: z.string().min(1, 'Issue date is required'), // ISO date string from input[type=date]
      expiryDate: z.string().optional().or(z.literal('')),
    })

    // Step 5: Past Projects (single project for add/edit)
    export const PROJECT_VALUE_RANGES = [
      'Under 50k',
      '50k - 100k',
      '100k - 250k',
      '250k - 500k',
      '500k - 1M',
      'Over 1M',
    ] as const

    export const projectSchema = z.object({
      name: z.string().min(1, 'Project name is required').max(100),
      clientName: z.string().min(1, 'Client name is required').max(100),
      description: z.string().min(1, 'Project description is required').max(1000),
      sector: z.string().min(1, 'Sector is required'),
      valueRange: z.string().min(1, 'Value range is required'),
      yearCompleted: z.coerce.number().min(2000).max(new Date().getFullYear()),
    })

    // Types inferred from schemas
    export type CompanyInfoFormValues = z.infer<typeof companyInfoSchema>
    export type SectorsFormValues = z.infer<typeof sectorsSchema>
    export type CapabilitiesFormValues = z.infer<typeof capabilitiesSchema>
    export type CertificationFormValues = z.infer<typeof certificationSchema>
    export type ProjectFormValues = z.infer<typeof projectSchema>
    ```

    Verify TypeScript compilation: `npx tsc --noEmit` (may have some pre-existing issues, focus on new files being error-free).
  </action>
  <verify>
    - All shadcn/ui components installed: check `ls src/components/ui/` includes checkbox.tsx, textarea.tsx, dialog.tsx, badge.tsx, progress.tsx, select.tsx, table.tsx, separator.tsx
    - `src/lib/validations/profile.ts` exists and exports all 5 schemas plus types
    - `npx tsc --noEmit` reports no errors in the new validations file (grep for "profile.ts" in output)
  </verify>
  <done>
    All 8 new shadcn/ui components installed. Zod schemas exist for all 5 wizard steps with proper constraints (company name min 2 chars, at least 1 sector required, capability description max 500 chars, certification fields required, project fields with value ranges). Type exports available for form integration.
  </done>
</task>

</tasks>

<verification>
- Prisma schema has Company (with sectors[], sectorSubcategories, country, size, website, capabilityDescription, capabilityTags[]), Certification model, Project model
- Database migration applied successfully
- Seed data creates demo company with new fields + sample certifications + sample projects
- Zod validation schemas cover all 5 wizard steps
- shadcn/ui components available: checkbox, textarea, dialog, badge, progress, select, table, separator
</verification>

<success_criteria>
- `npx prisma db push` and `npx prisma db seed` both succeed
- `src/lib/validations/profile.ts` exports 5 schemas and 5 type aliases
- `ls src/components/ui/` shows at least 13 component files (5 existing + 8 new)
- TypeScript compiles without errors in new files
</success_criteria>

<output>
After completion, create `.planning/phases/02-company-profiling/02-01-SUMMARY.md`
</output>
