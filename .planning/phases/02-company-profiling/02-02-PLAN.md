---
phase: 02-company-profiling
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/actions/profile.ts
  - src/app/dashboard/profile/wizard/page.tsx
  - src/components/profile/wizard/wizard-container.tsx
  - src/components/profile/wizard/wizard-progress.tsx
  - src/components/profile/wizard/step-company-info.tsx
  - src/components/profile/wizard/step-sectors.tsx
autonomous: true

must_haves:
  truths:
    - "Server actions can save each wizard step's data independently (auto-save on blur)"
    - "Wizard container shows progress bar and renders correct step"
    - "User can fill in company info (name, country, size, website, description) in Step 1"
    - "User can select one or both sectors with sub-categories in Step 2"
    - "Data persists when navigating between steps"
  artifacts:
    - path: "src/actions/profile.ts"
      provides: "Server actions for profile CRUD and completeness"
      exports: ["saveCompanyInfo", "saveSectors", "saveCapabilities", "saveCertification", "deleteCertification", "saveProject", "deleteProject", "getCompanyProfile", "getProfileCompleteness"]
    - path: "src/components/profile/wizard/wizard-container.tsx"
      provides: "Multi-step wizard shell with step navigation"
    - path: "src/components/profile/wizard/step-company-info.tsx"
      provides: "Step 1 form"
    - path: "src/components/profile/wizard/step-sectors.tsx"
      provides: "Step 2 sector selection"
  key_links:
    - from: "src/components/profile/wizard/step-company-info.tsx"
      to: "src/actions/profile.ts"
      via: "saveCompanyInfo server action on blur"
      pattern: "saveCompanyInfo"
    - from: "src/components/profile/wizard/step-sectors.tsx"
      to: "src/actions/profile.ts"
      via: "saveSectors server action on change"
      pattern: "saveSectors"
    - from: "src/app/dashboard/profile/wizard/page.tsx"
      to: "src/actions/profile.ts"
      via: "getCompanyProfile to pre-populate wizard"
      pattern: "getCompanyProfile"
---

<objective>
Create all server actions for profile management and build the wizard shell with the first two steps (Company Info + Industry Sectors).

Purpose: Server actions enable auto-save on blur, which is the core UX pattern for the wizard. The wizard container manages step state and navigation. Steps 1-2 cover company identity and sector selection, the foundation for all subsequent profile data.

Output: Complete server action layer for all profile operations. Working wizard with navigable steps, progress bar, and functional Steps 1-2 with auto-save.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-company-profiling/02-CONTEXT.md
@.planning/phases/02-company-profiling/02-RESEARCH.md
@.planning/phases/02-company-profiling/02-01-SUMMARY.md
@src/lib/dal.ts
@src/actions/auth.ts
@src/lib/validations/profile.ts
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server actions for all profile operations</name>
  <files>src/actions/profile.ts</files>
  <action>
    Create `src/actions/profile.ts` with all server actions for profile CRUD. Use the established pattern from `src/actions/auth.ts` (server action with 'use server', Zod validation, Prisma queries).

    **All actions must verify session first** using `verifySession()` from `@/lib/dal`.

    **Company upsert pattern:** Each save action should upsert the Company record (create if not exists, update if exists) keyed on `ownerId` matching the authenticated user's ID. This enables auto-save -- partial data is saved immediately.

    Actions to create:

    1. `saveCompanyInfo(data: CompanyInfoFormValues)` - Upsert company with name, country, size, website, description. Validate with companyInfoSchema. Return `{ success: true, companyId: string }` or `{ success: false, errors: Record<string, string[]> }`.

    2. `saveSectors(data: SectorsFormValues)` - Update company sectors[] and sectorSubcategories. Validate with sectorsSchema.

    3. `saveCapabilities(data: CapabilitiesFormValues)` - Update company capabilityDescription and capabilityTags[]. Validate with capabilitiesSchema.

    4. `saveCertification(data: CertificationFormValues & { id?: string })` - Create new or update existing Certification. If `id` is provided, update; otherwise create. The certification must belong to the user's company. Validate with certificationSchema. Parse date strings to DateTime objects.

    5. `deleteCertification(id: string)` - Delete a certification by ID. Verify it belongs to the user's company before deleting.

    6. `saveProject(data: ProjectFormValues & { id?: string })` - Create new or update existing Project. If `id` is provided, update; otherwise create. Verify ownership. Validate with projectSchema.

    7. `deleteProject(id: string)` - Delete a project by ID. Verify ownership.

    8. `getCompanyProfile()` - Fetch the current user's company with all relations (certifications, projects). Return null if no company exists yet. Include `certifications` and `projects` in the Prisma include.

    9. `getProfileCompleteness()` - Calculate profile completeness. Return an object:
    ```typescript
    {
      complete: boolean,  // all 5 steps done
      percentage: number, // 0-100
      steps: {
        companyInfo: boolean,   // name + country + size filled
        sectors: boolean,       // at least 1 sector selected
        capabilities: boolean,  // description or at least 1 tag
        certifications: boolean, // at least 1 certification
        projects: boolean,      // at least 1 project
      }
    }
    ```

    **Error handling pattern:** Wrap each action in try/catch. On Zod validation failure, return structured errors. On Prisma errors, return generic error message. Never expose internal error details.

    **Return type pattern:**
    ```typescript
    type ActionResult =
      | { success: true; data?: unknown }
      | { success: false; errors?: Record<string, string[]>; message?: string }
    ```
  </action>
  <verify>
    - `src/actions/profile.ts` exists and exports all 9 functions
    - `npx tsc --noEmit` shows no errors in profile.ts
    - Each action starts with `verifySession()` call
    - Each mutation action validates input with appropriate Zod schema
  </verify>
  <done>
    All 9 server actions exist and compile. Each verifies session, validates input, and returns structured results. Company upsert pattern enables auto-save. getProfileCompleteness returns step-by-step status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build wizard page, container, progress bar, and Steps 1-2</name>
  <files>
    src/app/dashboard/profile/wizard/page.tsx
    src/components/profile/wizard/wizard-container.tsx
    src/components/profile/wizard/wizard-progress.tsx
    src/components/profile/wizard/step-company-info.tsx
    src/components/profile/wizard/step-sectors.tsx
  </files>
  <action>
    **Wizard page** (`src/app/dashboard/profile/wizard/page.tsx`):
    - Server component that verifies session via DAL
    - Fetches existing company profile via `getCompanyProfile()` action
    - Passes profile data to WizardContainer as initial data for pre-population
    - Read initial step from URL search params (`?step=1` through `?step=5`, default 1)
    - If company exists, start at first incomplete step (using getProfileCompleteness)

    **WizardContainer** (`src/components/profile/wizard/wizard-container.tsx`):
    - 'use client' component (needs state for current step)
    - Props: `initialData` (company profile or null), `initialStep` (number 1-5), `completeness` (from getProfileCompleteness)
    - State: `currentStep` (1-5), managed via useState
    - Renders WizardProgress at top
    - Renders the appropriate step component based on currentStep
    - Navigation buttons at bottom: "Back" (disabled on step 1), "Next" / "Skip" (skip marks step as skipped), "Finish" on step 5
    - "Next" advances step, "Skip" also advances step
    - Update URL search param when step changes (use `useRouter` or `window.history.replaceState` to avoid full page reload)
    - Navigation button styling: primary "Next"/"Finish" button, outline "Back" button, ghost "Skip" button

    **WizardProgress** (`src/components/profile/wizard/wizard-progress.tsx`):
    - Props: `currentStep` (1-5), `completeness` (step status object)
    - Simple percentage-based progress bar using shadcn Progress component
    - Calculate percentage: (completed steps / 5) * 100
    - Show "Step X of 5" text above the progress bar
    - No step labels per user decision (just the bar and text)

    **Step 1: Company Info** (`src/components/profile/wizard/step-company-info.tsx`):
    - 'use client' component
    - Props: `initialData` (existing company info or null for pre-population)
    - React Hook Form with zodResolver using companyInfoSchema
    - Fields: Company Name (Input, required), Country (Input, required), Company Size (Select dropdown with COMPANY_SIZES options), Website (Input, optional), Brief Description (Textarea, optional, with character counter showing X/300)
    - **Auto-save on blur:** Each field's onBlur triggers form validation for that field, then calls `saveCompanyInfo` server action with current form values if valid. Use a debounce wrapper (500ms) to avoid rapid-fire saves.
    - Show subtle "Saved" indicator (small text/icon) that appears briefly after successful save
    - Pre-populate form with initialData if company exists
    - Character counter for description: show "X / 300" below textarea, change color to warning when near limit (>270 chars)

    **Step 2: Industry Sectors** (`src/components/profile/wizard/step-sectors.tsx`):
    - 'use client' component
    - Props: `initialData` (existing sectors/subcategories or null)
    - Two top-level checkboxes: "IT & Software" and "Construction" (per user decision: checkbox list, not cards)
    - When a sector is checked, show its sub-categories below as indented checkboxes:
      - IT: Cloud Services, Cybersecurity, Software Development, Data Analytics, IT Consulting
      - Construction: Renovation & Refurbishment, New Build - Commercial, New Build - Residential, Infrastructure, Demolition & Clearance
    - Multi-select: user can pick one or both sectors
    - **Auto-save on change:** When sector selection changes, call `saveSectors` server action after 500ms debounce
    - Pre-populate from initialData
    - Validation: at least 1 sector must be selected (show error message below checkboxes if 0 selected on blur/next)
  </action>
  <verify>
    - Navigate to `/dashboard/profile/wizard` — wizard loads with progress bar showing "Step 1 of 5"
    - Step 1 form renders all fields (name, country, size, website, description)
    - Fill in company info, tab between fields — auto-save triggers (check server action via console or network tab)
    - Click "Next" — advances to Step 2
    - Step 2 shows sector checkboxes — check IT, sub-categories appear
    - Click "Back" — returns to Step 1 with data preserved
    - `npm run build` completes without errors
  </verify>
  <done>
    Wizard page loads at /dashboard/profile/wizard with progress bar. Step 1 shows company info form with auto-save on blur and character counter. Step 2 shows sector checkbox list with sub-categories and auto-save on change. Navigation works between steps. Data pre-populates from existing profile.
  </done>
</task>

</tasks>

<verification>
- All 9 server actions compile and are exported from src/actions/profile.ts
- Wizard page is accessible at /dashboard/profile/wizard (authenticated)
- Progress bar shows correct step number and percentage
- Step 1 form fields save automatically on blur
- Step 2 checkboxes save automatically on change
- Navigation between steps works (Back, Next, Skip)
- Data persists across step navigation (pre-populated from database)
- `npm run build` succeeds
</verification>

<success_criteria>
- Server actions handle create, read, update, delete for all profile entities
- Wizard container manages 5-step navigation with URL sync
- Steps 1-2 render correct form controls with auto-save
- Profile data persists in database between wizard visits
</success_criteria>

<output>
After completion, create `.planning/phases/02-company-profiling/02-02-SUMMARY.md`
</output>
