---
phase: 02-company-profiling
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/components/profile/wizard/step-capabilities.tsx
  - src/components/profile/wizard/step-certifications.tsx
  - src/components/profile/wizard/step-projects.tsx
  - src/components/profile/project-dialog.tsx
  - src/components/profile/tag-input.tsx
autonomous: true

must_haves:
  truths:
    - "User can write a capability description and add/remove tags in Step 3"
    - "User can add, edit, and delete certifications in Step 4"
    - "User can add, edit, and delete past projects via modal dialog in Step 5"
    - "Past projects display in a table with name, client, sector, value, year columns"
    - "All three steps auto-save and pre-populate from existing data"
  artifacts:
    - path: "src/components/profile/wizard/step-capabilities.tsx"
      provides: "Step 3 with description textarea and tag input"
    - path: "src/components/profile/wizard/step-certifications.tsx"
      provides: "Step 4 with certification list and add/edit/delete"
    - path: "src/components/profile/wizard/step-projects.tsx"
      provides: "Step 5 with projects table and modal dialog"
    - path: "src/components/profile/project-dialog.tsx"
      provides: "Reusable modal for adding/editing projects"
    - path: "src/components/profile/tag-input.tsx"
      provides: "Tag input component with chips"
  key_links:
    - from: "src/components/profile/wizard/step-capabilities.tsx"
      to: "src/actions/profile.ts"
      via: "saveCapabilities on blur/change"
      pattern: "saveCapabilities"
    - from: "src/components/profile/wizard/step-certifications.tsx"
      to: "src/actions/profile.ts"
      via: "saveCertification and deleteCertification"
      pattern: "saveCertification|deleteCertification"
    - from: "src/components/profile/wizard/step-projects.tsx"
      to: "src/actions/profile.ts"
      via: "saveProject and deleteProject"
      pattern: "saveProject|deleteProject"
---

<objective>
Build wizard Steps 3-5: Capabilities & Tags, Certifications, and Past Projects with all required supporting components.

Purpose: These three steps complete the wizard form flow. Step 3 introduces the custom tag input pattern. Step 4 requires inline CRUD for certifications. Step 5 requires a table display with modal add/edit — the most complex interaction pattern in the wizard.

Output: Three fully functional wizard steps with auto-save, plus reusable tag-input and project-dialog components.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-company-profiling/02-CONTEXT.md
@.planning/phases/02-company-profiling/02-RESEARCH.md
@.planning/phases/02-company-profiling/02-02-SUMMARY.md
@src/actions/profile.ts
@src/lib/validations/profile.ts
@src/components/profile/wizard/wizard-container.tsx
@src/components/profile/wizard/step-company-info.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build tag input component and Step 3 (Capabilities & Tags)</name>
  <files>
    src/components/profile/tag-input.tsx
    src/components/profile/wizard/step-capabilities.tsx
  </files>
  <action>
    **Tag Input Component** (`src/components/profile/tag-input.tsx`):
    - 'use client' component
    - Build a custom tag input (simpler than adding Emblor dependency — per research, this is optional):
    - Props: `value: string[]`, `onChange: (tags: string[]) => void`, `placeholder?: string`, `maxTags?: number`
    - UI: An input field at the top. Below it, a flex-wrap container of tag chips (Badge components)
    - Behavior:
      - User types text and presses Enter (or comma) to add a tag
      - New tag is trimmed, lowercased (for consistency), and added to the array
      - Duplicate tags are silently ignored
      - Each tag chip shows the tag text + an "x" button to remove
      - Clicking "x" removes the tag from the array
      - Show tag count: "X / 20 tags" (soft limit, per user decision — shown but not enforced)
      - Keyboard: Backspace on empty input removes the last tag
    - Styling: Use shadcn Badge (variant="secondary") for tags, Input for the text field
    - Accessibility: aria-label on remove buttons, proper focus management

    **Step 3: Capabilities & Tags** (`src/components/profile/wizard/step-capabilities.tsx`):
    - 'use client' component
    - Props: `initialData` (existing capabilityDescription + capabilityTags or null)
    - Two sections:
      1. **Capability Description**: Textarea with character counter (X / 500, soft limit). Auto-save on blur after 500ms debounce.
      2. **Capability Tags**: TagInput component. Auto-save when tags change (onChange triggers saveCapabilities after 500ms debounce).
    - Use `saveCapabilities` server action for both saves (sends current description + tags together)
    - Pre-populate from initialData
    - Show a brief helper text: "Describe your core capabilities and services" above the textarea, "Add tags that describe your expertise" above the tag input
    - "Saved" indicator after successful auto-save

    **Update wizard-container.tsx** to import and render step-capabilities for step 3.
  </action>
  <verify>
    - Navigate to wizard Step 3 — textarea and tag input render
    - Type in textarea, tab away — auto-save fires
    - Character counter shows correct count and changes color near 500
    - Type tag name, press Enter — tag appears as chip
    - Click "x" on tag — tag removed
    - Press Backspace on empty input — last tag removed
    - Tag count displays "X / 20 tags"
    - Revisit step — data is pre-populated from database
  </verify>
  <done>
    Tag input component works with Enter/comma to add, x/Backspace to remove, and shows count. Step 3 renders capability description with character counter and tag input, both auto-saving on blur/change. Data pre-populates from existing profile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Step 4 (Certifications) and Step 5 (Past Projects with modal)</name>
  <files>
    src/components/profile/wizard/step-certifications.tsx
    src/components/profile/wizard/step-projects.tsx
    src/components/profile/project-dialog.tsx
  </files>
  <action>
    **Step 4: Certifications** (`src/components/profile/wizard/step-certifications.tsx`):
    - 'use client' component
    - Props: `initialData` (array of existing certifications or empty array)
    - State: local certifications list (initialized from initialData), isAdding flag
    - UI Layout:
      - Header: "Certifications" with "Add Certification" button
      - List of existing certifications as Cards, each showing:
        - Name (bold), Issuing Body, Issue Date (formatted), Expiry Date (if set, formatted)
        - "Edit" and "Delete" buttons (small, outline variant)
      - When "Add" or "Edit" is clicked, show an inline form (NOT a modal — simpler UX for certifications):
        - Fields: Name (Input), Issuing Body (Input), Issue Date (date Input), Expiry Date (date Input, optional)
        - "Save" and "Cancel" buttons
        - Validate with certificationSchema on save
        - On save: call `saveCertification` server action, on success add/update in local state
      - "Delete" calls `deleteCertification` server action, removes from local state on success
    - Show helper text: "Add relevant certifications (ISO, security clearances, industry certifications)"
    - Show status: "At least 1 certification required to complete this step" if list is empty
    - Error/success feedback via inline messages

    **Project Dialog** (`src/components/profile/project-dialog.tsx`):
    - 'use client' component
    - Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `project?: ProjectFormValues & { id?: string }` (for edit mode), `onSave: (project: ProjectFormValues & { id?: string }) => Promise<void>`
    - Uses shadcn Dialog component
    - Title: "Add Project" or "Edit Project" based on whether `project` prop exists
    - Form inside dialog using React Hook Form with projectSchema:
      - Project Name (Input)
      - Client Name (Input)
      - Description (Textarea)
      - Sector (Select dropdown: IT, Construction)
      - Contract Value Range (Select dropdown: PROJECT_VALUE_RANGES)
      - Year Completed (Input type number, min 2000, max current year)
    - "Save" button validates form, calls onSave prop, closes dialog on success
    - "Cancel" button closes dialog without saving
    - Pre-populate form when editing existing project

    **Step 5: Past Projects** (`src/components/profile/wizard/step-projects.tsx`):
    - 'use client' component
    - Props: `initialData` (array of existing projects or empty array)
    - State: local projects list, dialogOpen, editingProject (for edit mode)
    - UI Layout:
      - Header: "Past Projects" with "Add Project" button
      - Table (shadcn Table component) with columns: Name, Client, Sector, Value Range, Year, Actions
      - Actions column: "Edit" and "Delete" buttons per row
      - "Add Project" opens ProjectDialog in create mode
      - "Edit" opens ProjectDialog in edit mode with project data
      - "Delete" calls `deleteProject` server action, removes from local state
      - Empty state: "No projects added yet. Add at least one project to complete your profile."
    - On dialog save: call `saveProject` server action, add to/update local state on success
    - Show status: "At least 1 project required to complete this step" if table is empty

    **Update wizard-container.tsx** to import and render step-certifications for step 4 and step-projects for step 5.

    **Update wizard-container.tsx** "Finish" button on step 5: Navigate to `/dashboard/profile` (the profile view page, to be built in Plan 04). For now, navigate to `/dashboard` with a success indication.
  </action>
  <verify>
    - Navigate to wizard Step 4 — shows certification list (empty or pre-populated)
    - Click "Add Certification" — inline form appears
    - Fill in name, issuing body, dates — click Save — certification appears in list
    - Click "Edit" on certification — form pre-populates, can modify and save
    - Click "Delete" — certification removed from list and database
    - Navigate to Step 5 — shows projects table (empty or pre-populated)
    - Click "Add Project" — dialog modal opens with form
    - Fill in project details — click Save — project appears in table
    - Click "Edit" on project row — dialog opens with pre-populated data
    - Click "Delete" on project row — project removed
    - Click "Finish" on Step 5 — navigates to dashboard
    - Revisit wizard — all data pre-populated from database
    - `npm run build` succeeds
  </verify>
  <done>
    Step 4 shows certifications with inline add/edit/delete forms. Step 5 shows projects table with modal dialog for add/edit and delete capability. Both steps persist data via server actions. Wizard is fully navigable through all 5 steps. Finish button redirects to dashboard.
  </done>
</task>

</tasks>

<verification>
- All 5 wizard steps render and are navigable
- Tag input component adds/removes tags with keyboard support
- Certifications can be added, edited, and deleted inline
- Projects table displays with modal for add/edit
- All steps auto-save or save on action
- Data persists across wizard visits
- `npm run build` succeeds
</verification>

<success_criteria>
- Custom tag input works with Enter to add, x/Backspace to remove
- Step 3 saves capability description + tags via auto-save
- Step 4 has full CRUD for certifications with inline forms
- Step 5 has full CRUD for projects via table + modal dialog
- Complete wizard walkthrough possible from Step 1 to Finish
</success_criteria>

<output>
After completion, create `.planning/phases/02-company-profiling/02-03-SUMMARY.md`
</output>
