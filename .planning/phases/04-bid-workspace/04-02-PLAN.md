---
phase: 04-bid-workspace
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/dashboard/tenders/[id]/bid/page.tsx
  - src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx
  - src/app/dashboard/tenders/[id]/bid/components/question-card.tsx
  - src/app/dashboard/tenders/[id]/bid/components/deadline-timer.tsx
  - src/app/dashboard/tenders/[id]/bid/components/progress-indicator.tsx
  - src/app/dashboard/tenders/[id]/bid/components/bid-status-badge.tsx
autonomous: true

must_haves:
  truths:
    - "User sees structured questions derived from the tender's requirements"
    - "User can navigate between questions (next/previous)"
    - "Answers auto-save with 500ms debounce and toast feedback"
    - "Deadline countdown timer ticks in real-time with proper cleanup"
    - "Progress indicator shows answered/total questions"
    - "User can return to draft and resume from where they left off"
  artifacts:
    - path: "src/app/dashboard/tenders/[id]/bid/page.tsx"
      provides: "Server component page that fetches bid/tender data and generates questions"
      min_lines: 40
    - path: "src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx"
      provides: "Main Q&A container with auto-save, form state, and question navigation"
      min_lines: 80
    - path: "src/app/dashboard/tenders/[id]/bid/components/question-card.tsx"
      provides: "Individual question rendering with textarea/text/select/number inputs"
      min_lines: 40
    - path: "src/app/dashboard/tenders/[id]/bid/components/deadline-timer.tsx"
      provides: "Real-time countdown timer with urgent/expired states"
      min_lines: 30
    - path: "src/app/dashboard/tenders/[id]/bid/components/progress-indicator.tsx"
      provides: "Visual progress bar with answered/total count"
      min_lines: 20
    - path: "src/app/dashboard/tenders/[id]/bid/components/bid-status-badge.tsx"
      provides: "Bid status badge with color coding"
      min_lines: 15
  key_links:
    - from: "src/app/dashboard/tenders/[id]/bid/page.tsx"
      to: "src/lib/bids/questions.ts"
      via: "generateQuestionsFromRequirements call"
      pattern: "generateQuestionsFromRequirements"
    - from: "src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx"
      to: "src/actions/bids.ts"
      via: "saveBidDraft for auto-save"
      pattern: "saveBidDraft"
    - from: "src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx"
      to: "use-debounce"
      via: "useDebouncedCallback for auto-save"
      pattern: "useDebouncedCallback"
    - from: "src/app/dashboard/tenders/[id]/bid/components/deadline-timer.tsx"
      to: "setInterval/clearInterval"
      via: "useEffect with cleanup"
      pattern: "clearInterval"
---

<objective>
Build the complete bid workspace Q&A interface — the page that presents tender-specific questions one at a time, with auto-save on answer changes, real-time deadline countdown, progress tracking, and question navigation.

Purpose: This is the core user experience of Phase 4 — the workspace where SMEs actually answer bid questions.
Output: Fully functional bid workspace page at /dashboard/tenders/[id]/bid with all interactive components.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-bid-workspace/04-RESEARCH.md
@.planning/phases/04-bid-workspace/04-01-SUMMARY.md
@prisma/schema.prisma
@src/lib/dal.ts
@src/lib/prisma.ts
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bid workspace page and main workspace component</name>
  <files>
    src/app/dashboard/tenders/[id]/bid/page.tsx
    src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx
  </files>
  <action>
    **src/app/dashboard/tenders/[id]/bid/page.tsx** — Server Component:
    1. Import verifySession from `@/lib/dal`, prisma from `@/lib/prisma`, generateQuestionsFromRequirements from `@/lib/bids/questions`, redirect from `next/navigation`
    2. Async function BidWorkspacePage with params: `Promise<{ id: string }>`
    3. Await params to get tenderId, call verifySession()
    4. Fetch user's company: `prisma.company.findUnique({ where: { ownerId: session.userId } })`. If no company, redirect to `/dashboard/profile/wizard`
    5. Fetch tender: `prisma.tender.findUnique({ where: { id: tenderId } })`. If not found, redirect to `/dashboard/tenders`
    6. Find or create bid: `prisma.bid.findFirst({ where: { tenderId, companyId: company.id } })`. If no bid exists, create one with status DRAFT and empty content `{}`
    7. Parse tender requirements: `JSON.parse(tender.requirements as string)` with try/catch fallback to `{}`
    8. Generate questions: `generateQuestionsFromRequirements(requirements, tender.title, tender.sector)`
    9. Prepare initial answers: `(bid.content as Record<string, unknown>) || {}`
    10. Determine `lastAnsweredIndex`: iterate through questions array to find the index of the last question that has a non-empty answer in initialAnswers. Default to 0 if no answers.
    11. Render BidWorkspace client component passing: `bid` (with id, status, updatedAt), `tender` (with id, title, sector, deadline, value), `questions`, `initialAnswers`, `startIndex: lastAnsweredIndex`
    12. Pass deadline as ISO string: `tender.deadline.toISOString()` (for timezone safety)

    **src/app/dashboard/tenders/[id]/bid/components/bid-workspace.tsx** — Client Component ('use client'):
    1. Import: useState, useEffect from react; useForm, FormProvider from react-hook-form; useDebouncedCallback from use-debounce; toast from sonner; saveBidDraft, updateBidStatus from @/actions/bids; all child components
    2. Props type: `{ bid: { id: string, status: string, updatedAt: string }, tender: { id: string, title: string, sector: string, deadline: string, value: number }, questions: Question[], initialAnswers: Record<string, unknown>, startIndex: number }`
    3. State: `currentQuestionIndex` (init to startIndex prop), `isSaving` (boolean)
    4. Create form with useForm: defaultValues from initialAnswers, mode: 'onBlur'
    5. Create debouncedSave with useDebouncedCallback (500ms, maxWait: 2000ms):
       - If isSaving, return (skip concurrent saves)
       - Set isSaving true
       - Call saveBidDraft(bid.id, data)
       - On success: toast.success('Draft saved', { duration: 2000 })
       - On error: toast.error('Failed to save draft')
       - Finally: set isSaving false
    6. Watch form changes with useEffect + form.watch subscription, trigger debouncedSave on change. Return cleanup (subscription.unsubscribe).
    7. beforeunload warning: useEffect that adds/removes 'beforeunload' listener when form.formState.isDirty
    8. Ctrl+S / Cmd+S handler: useEffect that listens for keydown, prevents default, calls debouncedSave.flush()
    9. handleNext: validate current question field with form.trigger(currentQuestion.id), if valid and not last, increment index
    10. handlePrevious: decrement index if not first
    11. Calculate answeredCount from form.getValues() — count non-empty, non-null, non-undefined values that match question IDs
    12. Calculate progress percentage: (answeredCount / questions.length) * 100
    13. Render layout:
        - Header row: tender title (h1, text-2xl font-bold), bid status badge, deadline timer
        - Back link to `/dashboard/tenders/${tender.id}` with ArrowLeft icon
        - Progress indicator
        - FormProvider wrapping the question card
        - Question navigation card (QuestionCard component)
        - Saving indicator: "Saving..." text when isSaving is true
        - Bottom actions: if on last question and all required answered, show "Submit for Review" button that calls updateBidStatus(bid.id, 'IN_REVIEW')
    14. Use Tailwind: max-w-4xl mx-auto, space-y-6 for main container
  </action>
  <verify>
    - Both files exist and have no TypeScript errors
    - Page server component properly fetches data and generates questions
    - Workspace component uses 'use client' directive
    - useDebouncedCallback imported from use-debounce with 500ms delay
    - toast imported from sonner
    - beforeunload event listener present with cleanup
    - Ctrl+S handler present with cleanup
    - `npx next build` passes
  </verify>
  <done>
    Bid workspace page server component fetches bid/tender data, generates questions, and renders the BidWorkspace client component. BidWorkspace manages form state, auto-saves with 500ms debounce + toast feedback, warns before unload, handles Ctrl+S, and provides question navigation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create supporting components — question card, deadline timer, progress, status badge</name>
  <files>
    src/app/dashboard/tenders/[id]/bid/components/question-card.tsx
    src/app/dashboard/tenders/[id]/bid/components/deadline-timer.tsx
    src/app/dashboard/tenders/[id]/bid/components/progress-indicator.tsx
    src/app/dashboard/tenders/[id]/bid/components/bid-status-badge.tsx
  </files>
  <action>
    **src/app/dashboard/tenders/[id]/bid/components/question-card.tsx** — Client Component:
    1. Props: `{ question: Question, form: UseFormReturn<any>, onNext: () => void, onPrevious: () => void, isFirst: boolean, isLast: boolean }`
    2. Render a Card with:
       - CardHeader: question.text as CardTitle, question.helpText as CardDescription if present
       - CardContent: FormField using form.control and question.id as name
         - If question.type === 'textarea': Textarea with rows={6}, placeholder
         - If question.type === 'select': Select with SelectTrigger/SelectContent/SelectItem for each option
         - If question.type === 'number': Input type="number" with onChange converting to Number
         - If question.type === 'text': Input type="text"
         - Show required indicator (* in red) if question.required
         - FormMessage for validation errors
       - CardFooter: flex justify-between
         - Previous button (variant="outline", disabled if isFirst) with ChevronLeft icon
         - Next button (or "Review Answers" if isLast) with ChevronRight icon
    3. Import Question type from @/lib/bids/questions
    4. Import shadcn components: Card, CardContent, CardHeader, CardTitle, CardDescription, CardFooter, FormField, FormItem, FormLabel, FormControl, FormDescription, FormMessage, Input, Textarea, Select, SelectTrigger, SelectContent, SelectItem, SelectValue, Button
    5. Import ChevronLeft, ChevronRight from lucide-react

    **src/app/dashboard/tenders/[id]/bid/components/deadline-timer.tsx** — Client Component:
    1. Props: `{ deadline: string }` (ISO string from server)
    2. State: timeRemaining with { days, hours, minutes, seconds, isUrgent, isPast }
    3. Helper function calculateTimeRemaining(deadline: string): parse with new Date(), calculate diff in ms, derive days/hours/mins/secs, isUrgent = diff < 24*60*60*1000, isPast = diff <= 0
    4. useEffect with setInterval(1000ms) that updates timeRemaining. CRITICAL: return cleanup function `() => clearInterval(timer)`. Dependency: [deadline].
    5. If isPast: render Badge variant="destructive" with AlertTriangle icon and "Deadline passed"
    6. Otherwise render: Clock icon (orange if urgent), formatted time "{days}d HH:MM:SS remaining"
    7. Import Clock, AlertTriangle from lucide-react, Badge from shadcn

    **src/app/dashboard/tenders/[id]/bid/components/progress-indicator.tsx** — Client Component:
    1. Props: `{ current: number, total: number, answered: number }`
    2. Calculate progress percentage: `(answered / total) * 100`
    3. Render:
       - Text row: "Question {current} of {total}" on left, "{answered} / {total} answered" on right
       - shadcn Progress component with calculated value
       - Status text: CheckCircle2 (green) "All questions answered" if answered === total, else Circle icon "{total - answered} questions remaining"
    4. Import Progress from @/components/ui/progress, CheckCircle2 and Circle from lucide-react

    **src/app/dashboard/tenders/[id]/bid/components/bid-status-badge.tsx** — Client Component:
    1. Props: `{ status: string }`
    2. Map status to Badge variant and label:
       - DRAFT: variant="secondary", label="Draft"
       - IN_REVIEW: variant="default", label="In Review"
       - FINALIZED: variant="outline" with green text, label="Finalized"
       - SUBMITTED: variant="outline" with blue text, label="Submitted"
    3. Render Badge with appropriate variant and color
    4. Import Badge from shadcn
  </action>
  <verify>
    - All four component files exist with 'use client' directive
    - deadline-timer.tsx has clearInterval in useEffect cleanup
    - question-card.tsx handles all four input types (text, textarea, number, select)
    - progress-indicator.tsx uses shadcn Progress component
    - bid-status-badge.tsx maps all four BidStatus values
    - `npx next build` completes without errors
    - Navigate to `/dashboard/tenders/{any-tender-id}/bid` — page loads without runtime errors
  </verify>
  <done>
    All bid workspace components render correctly: QuestionCard shows input matching question type with navigation buttons, DeadlineTimer ticks every second with proper cleanup, ProgressIndicator shows answered/total with progress bar, BidStatusBadge shows color-coded status.
  </done>
</task>

</tasks>

<verification>
- Visit `/dashboard/tenders/{tender-id}/bid` while logged in with a company profile
- Questions are generated from the tender's requirements JSON
- Can navigate between questions with Next/Previous
- Answering a question triggers auto-save (toast appears "Draft saved" after ~500ms)
- Deadline countdown timer shows and ticks
- Progress bar updates as questions are answered
- Refreshing the page restores previously saved answers
- Ctrl+S forces immediate save
- Navigating away with unsaved changes shows browser warning
</verification>

<success_criteria>
- Bid workspace page loads at /dashboard/tenders/[id]/bid
- Questions derived from tender requirements (5-8 questions typical)
- Auto-save works with 500ms debounce and toast feedback
- Countdown timer ticks in real-time with cleanup on unmount
- Progress indicator reflects actual answered count
- Returning to page resumes from last answered question
- Status badge shows current bid status
</success_criteria>

<output>
After completion, create `.planning/phases/04-bid-workspace/04-02-SUMMARY.md`
</output>
