---
phase: 04-bid-workspace
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/app/layout.tsx
  - src/lib/bids/questions.ts
  - src/lib/bids/queries.ts
  - src/lib/bids/validation.ts
  - src/actions/bids.ts
autonomous: true

must_haves:
  truths:
    - "Mock questions are generated from tender requirements JSON (tags, certifications, experience, projectTypes)"
    - "Bid can be created, saved, and status-updated via server actions with ownership verification"
    - "Bid completeness can be validated before status transitions"
    - "Toast notifications are available app-wide via sonner Toaster"
  artifacts:
    - path: "src/lib/bids/questions.ts"
      provides: "Question generation from tender requirements"
      exports: ["generateQuestionsFromRequirements", "Question"]
    - path: "src/lib/bids/queries.ts"
      provides: "Bid data fetching with tender relations"
      exports: ["getBidByTenderAndUser", "getBidsByUser"]
    - path: "src/lib/bids/validation.ts"
      provides: "Bid answer validation and status transition rules"
      exports: ["validateBidCompleteness", "isValidStatusTransition"]
    - path: "src/actions/bids.ts"
      provides: "Server actions for bid CRUD"
      exports: ["createBid", "saveBidDraft", "updateBidStatus"]
  key_links:
    - from: "src/actions/bids.ts"
      to: "prisma.bid"
      via: "Prisma CRUD operations"
      pattern: "prisma\\.bid\\.(create|update|findFirst|findUnique)"
    - from: "src/actions/bids.ts"
      to: "src/lib/dal.ts"
      via: "verifySession for auth"
      pattern: "verifySession"
    - from: "src/lib/bids/questions.ts"
      to: "tender.requirements JSON"
      via: "JSON parsing and template mapping"
      pattern: "generateQuestionsFromRequirements"
---

<objective>
Install dependencies (sonner, use-debounce), set up toast notifications, and build the complete bid data layer: mock question generation engine, bid CRUD server actions, bid query functions, and validation logic.

Purpose: Establish all data and business logic foundations that the bid workspace UI (Plan 02) and tender integration (Plan 03) will consume.
Output: Working server actions, question engine, query layer, and validation — all testable independently.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-bid-workspace/04-RESEARCH.md
@prisma/schema.prisma
@src/lib/dal.ts
@src/lib/prisma.ts
@src/actions/profile.ts
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and set up toast notifications</name>
  <files>
    package.json
    src/app/layout.tsx
  </files>
  <action>
    1. Install sonner via shadcn: `npx shadcn@latest add sonner` (this creates src/components/ui/sonner.tsx and installs the sonner package).
    2. Install use-debounce: `npm install use-debounce`.
    3. Add the Toaster component to src/app/layout.tsx:
       - Import `Toaster` from `@/components/ui/sonner`
       - Add `<Toaster position="bottom-right" />` inside the `<body>` tag, after `{children}`
    4. Verify both packages appear in package.json dependencies.

    Note: Do NOT install react-countdown — we will use a custom timer with date-fns (already installed) for MVP simplicity.
  </action>
  <verify>
    - `npm ls sonner` shows installed version
    - `npm ls use-debounce` shows installed version
    - src/components/ui/sonner.tsx exists
    - src/app/layout.tsx contains Toaster import and component
    - `npx next build` (or `npx next lint`) runs without errors related to new imports
  </verify>
  <done>
    sonner and use-debounce installed, Toaster rendered in root layout, app builds cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create bid data layer — question engine, server actions, queries, validation</name>
  <files>
    src/lib/bids/questions.ts
    src/lib/bids/queries.ts
    src/lib/bids/validation.ts
    src/actions/bids.ts
  </files>
  <action>
    **src/lib/bids/questions.ts** — Mock question generation engine:
    - Export a `Question` type: `{ id: string, text: string, type: 'text' | 'textarea' | 'number' | 'select', required: boolean, options?: string[], helpText?: string }`
    - Export `generateQuestionsFromRequirements(requirements: TenderRequirements, tenderTitle: string, tenderSector: string): Question[]`
    - Define `TenderRequirements` type matching the seed data structure: `{ tags?: string[], certifications?: string[], experience?: string[], technical?: string[], deliverables?: string[], projectTypes?: string[] }`
    - Always include standard questions: `company_overview` (textarea, required), `proposed_approach` (textarea, required), `timeline` (text, required), `budget_notes` (textarea, optional)
    - Dynamically add questions based on requirements:
      - If `tags` exist: capability_match question (textarea) referencing the specific tags
      - If `certifications` exist: certifications question (select with options: Yes all/Some/None but willing/No)
      - If `experience` exist: relevant_experience question (textarea) referencing experience items
      - If `technical` exist: technical_approach question (textarea) referencing technical requirements
      - If `deliverables` exist: deliverables_plan question (textarea) referencing deliverables
    - Target 5-8 questions per tender (varies by how many requirement types are present)
    - Do NOT use Zod validationSchema in the Question type (keep it simple for MVP, validation is separate)

    **src/lib/bids/validation.ts** — Validation logic:
    - Export `validateBidCompleteness(content: Record<string, unknown>, questions: Question[]): { complete: boolean, answeredCount: number, totalRequired: number, missingQuestions: string[] }`
    - A question is "answered" if its value is not undefined, not null, not empty string, and not 0 for numbers
    - Complete = all required questions answered
    - Export `isValidStatusTransition(current: BidStatus, next: BidStatus): boolean`
    - Valid transitions: DRAFT -> IN_REVIEW, IN_REVIEW -> FINALIZED, IN_REVIEW -> DRAFT (back to edit), FINALIZED -> SUBMITTED. All other transitions invalid.
    - Import BidStatus from `@prisma/client`

    **src/lib/bids/queries.ts** — Bid data fetching (mark with `import 'server-only'`):
    - Export `getBidByTenderAndUser(tenderId: string, userId: string)`: Find bid by tenderId + company.ownerId, include tender relation. Returns bid with tender or null.
    - Export `getBidsByUser(userId: string)`: Find all bids for user's company, include tender relation, ordered by updatedAt desc. Returns array of bids with tender.
    - Use prisma instance from `@/lib/prisma`

    **src/actions/bids.ts** — Server Actions (mark with `'use server'`):
    - Follow the ActionResult pattern from src/actions/profile.ts: `{ success: true, data?: unknown } | { success: false, errors?: Record<string, string[]>, message?: string }`
    - Export `createBid(tenderId: string)`:
      1. verifySession()
      2. Get user's company (findUnique by ownerId). If no company, return error "Complete your company profile first"
      3. Check for existing bid (findFirst by tenderId + companyId). If exists, return `{ success: true, data: { bidId: existingBid.id } }` (idempotent)
      4. Create new bid with status DRAFT and empty content `{}`
      5. revalidatePath for tender detail page
      6. Return `{ success: true, data: { bidId: bid.id } }`
    - Export `saveBidDraft(bidId: string, content: Record<string, unknown>)`:
      1. verifySession()
      2. Find bid and verify ownership (bid.company.ownerId === session.userId)
      3. Only allow saving if status is DRAFT or IN_REVIEW (not FINALIZED/SUBMITTED)
      4. Update bid content JSON and updatedAt
      5. Do NOT call revalidatePath (auto-save should not trigger revalidation — too frequent)
      6. Return `{ success: true }`
    - Export `updateBidStatus(bidId: string, newStatus: BidStatus)`:
      1. verifySession()
      2. Find bid and verify ownership
      3. Validate status transition using isValidStatusTransition
      4. If transitioning to FINALIZED or SUBMITTED: import generateQuestionsFromRequirements and validateBidCompleteness, check completeness. If not complete, return error with missing question count.
      5. Update bid status
      6. revalidatePath for bid workspace page
      7. Return `{ success: true }`
  </action>
  <verify>
    - All four files exist and have no TypeScript errors: `npx tsc --noEmit` passes (or at minimum, no errors in these new files)
    - src/lib/bids/questions.ts exports Question type and generateQuestionsFromRequirements function
    - src/actions/bids.ts exports createBid, saveBidDraft, updateBidStatus
    - src/lib/bids/queries.ts exports getBidByTenderAndUser, getBidsByUser
    - src/lib/bids/validation.ts exports validateBidCompleteness, isValidStatusTransition
    - `npx next build` completes without errors related to new files
  </verify>
  <done>
    Complete bid data layer: question generation produces 5-8 questions from tender requirements, server actions handle bid CRUD with ownership verification and status transition validation, queries fetch bids with tender relations, validation checks completeness. All files compile without errors.
  </done>
</task>

</tasks>

<verification>
- `npm ls sonner use-debounce` shows both installed
- All new files in src/lib/bids/ and src/actions/bids.ts exist
- TypeScript compilation passes for all new files
- No import errors or missing dependencies
- Toaster component renders in root layout
</verification>

<success_criteria>
- sonner and use-debounce installed, Toaster in layout
- generateQuestionsFromRequirements produces questions from tender requirements JSON
- createBid, saveBidDraft, updateBidStatus server actions work with ownership verification
- getBidByTenderAndUser and getBidsByUser query functions ready
- validateBidCompleteness and isValidStatusTransition provide business logic
- All files compile cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-bid-workspace/04-01-SUMMARY.md`
</output>
