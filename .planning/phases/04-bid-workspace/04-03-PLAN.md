---
phase: 04-bid-workspace
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/dashboard/tenders/[id]/page.tsx
  - src/components/bids/bid-actions.tsx
  - src/app/dashboard/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can start a new bid from the tender detail page"
    - "User sees 'Continue Bid' if they already have a draft for that tender"
    - "User can see bid status from the tender detail page"
    - "Dashboard shows active bids count or link to bids"
  artifacts:
    - path: "src/components/bids/bid-actions.tsx"
      provides: "Start Bid / Continue Bid button component"
      min_lines: 30
    - path: "src/app/dashboard/tenders/[id]/page.tsx"
      provides: "Updated tender detail page with bid actions section"
      contains: "BidActions"
    - path: "src/app/dashboard/page.tsx"
      provides: "Updated dashboard with active bids stat card"
      contains: "bids"
  key_links:
    - from: "src/components/bids/bid-actions.tsx"
      to: "src/actions/bids.ts"
      via: "createBid server action call"
      pattern: "createBid"
    - from: "src/components/bids/bid-actions.tsx"
      to: "/dashboard/tenders/[id]/bid"
      via: "router.push navigation"
      pattern: "router\\.push.*bid"
    - from: "src/app/dashboard/tenders/[id]/page.tsx"
      to: "src/components/bids/bid-actions.tsx"
      via: "component import and render"
      pattern: "BidActions"
---

<objective>
Add "Start Bid" / "Continue Bid" actions to the tender detail page so users can initiate bids, update the dashboard to show active bids, and verify the complete bid workflow visually.

Purpose: Connect the tender discovery flow (Phase 3) to the bid workspace (Plan 02), completing the user journey from "see tender" to "start bidding."
Output: Tender detail pages have bid action buttons, dashboard shows bid activity.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-bid-workspace/04-RESEARCH.md
@.planning/phases/04-bid-workspace/04-01-SUMMARY.md
@src/app/dashboard/tenders/[id]/page.tsx
@src/app/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BidActions component and integrate into tender detail page</name>
  <files>
    src/components/bids/bid-actions.tsx
    src/app/dashboard/tenders/[id]/page.tsx
    src/app/dashboard/page.tsx
  </files>
  <action>
    **src/components/bids/bid-actions.tsx** — Client Component ('use client'):
    1. Props: `{ tenderId: string, existingBidId?: string, existingBidStatus?: string }`
    2. State: isLoading (boolean)
    3. Import useRouter from next/navigation, Button from shadcn, createBid from @/actions/bids, toast from sonner, FileEdit icon from lucide-react
    4. handleStartBid async function:
       - Set isLoading true
       - Call createBid(tenderId)
       - If result has error: toast.error(result.message || 'Failed to create bid'), return
       - If result.success and result.data.bidId: router.push(`/dashboard/tenders/${tenderId}/bid`)
       - Finally: set isLoading false
    5. If existingBidId is provided (user already has a bid for this tender):
       - Show status text: "Your bid: {existingBidStatus}" with a "Continue Bid" Button (variant="outline") that navigates to `/dashboard/tenders/${tenderId}/bid`
       - If status is FINALIZED or SUBMITTED, show "View Bid" instead of "Continue Bid"
    6. If no existing bid:
       - Show "Start Bid" Button with FileEdit icon, disabled when isLoading
       - Show "Creating..." text when loading

    **src/app/dashboard/tenders/[id]/page.tsx** — Modify existing server component:
    1. Add import for prisma from @/lib/prisma
    2. Add import for BidActions from @/components/bids/bid-actions
    3. After fetching the tender and session, query for existing bid:
       ```
       const company = await prisma.company.findUnique({ where: { ownerId: session.userId } })
       let existingBid = null
       if (company) {
         existingBid = await prisma.bid.findFirst({
           where: { tenderId: id, companyId: company.id },
           select: { id: true, status: true }
         })
       }
       ```
    4. Add a bid actions section between the header and the key metrics row (or right after the status badges in the header area). Add it as a prominent section:
       - If tender.status === 'OPEN': render `<BidActions tenderId={id} existingBidId={existingBid?.id} existingBidStatus={existingBid?.status} />`
       - If tender.status !== 'OPEN': render a muted text "This tender is no longer accepting bids"
    5. Place the BidActions in the header section, after the badges div, before the key metrics grid. Add some margin-top (mt-4).

    **src/app/dashboard/page.tsx** — Modify existing dashboard:
    1. Add a query to count user's active bids (status DRAFT or IN_REVIEW):
       ```
       const company = await prisma.company.findUnique({ where: { ownerId: session.userId } })
       const activeBidsCount = company ? await prisma.bid.count({
         where: { companyId: company.id, status: { in: ['DRAFT', 'IN_REVIEW'] } }
       }) : 0
       ```
    2. Add an "Active Bids" stat card alongside existing dashboard cards. Use the FileEdit icon, show the count, and make it clickable linking to `/dashboard/tenders` (since we don't have a dedicated bids list page yet).
    3. If the dashboard doesn't already have a cards grid, add one. If it does, append the new card to it.
    4. Import prisma, FileEdit from lucide-react, Link from next/link as needed.
  </action>
  <verify>
    - src/components/bids/bid-actions.tsx exists with 'use client' directive
    - Tender detail page imports and renders BidActions
    - Dashboard page shows active bids count
    - `npx next build` passes
    - Navigate to a tender detail page — "Start Bid" button visible for OPEN tenders
    - Click "Start Bid" — creates bid and redirects to /dashboard/tenders/{id}/bid
    - Return to tender detail — shows "Continue Bid" instead
    - Dashboard shows active bids count card
  </verify>
  <done>
    "Start Bid" button on tender detail creates bid via server action and navigates to workspace. "Continue Bid" shown for existing drafts. Dashboard shows active bids count. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete bid workspace workflow across 3 plans:
    - Plan 01: Bid data layer (question engine, server actions, queries, validation, toast/debounce deps)
    - Plan 02: Bid workspace Q&A interface (page, workspace component, question cards, countdown timer, progress, auto-save)
    - Plan 03: Tender-to-bid integration (Start Bid button, Continue Bid, dashboard active bids)
  </what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev`
    2. Log in with existing credentials (demo user)
    3. Navigate to Dashboard — verify "Active Bids" card shows (should be 0 initially)
    4. Go to Tenders list, click any OPEN tender
    5. On tender detail page, verify "Start Bid" button is visible
    6. Click "Start Bid" — should redirect to /dashboard/tenders/{id}/bid
    7. Verify bid workspace loads with:
       - Tender title and "Draft" status badge in header
       - Deadline countdown timer ticking in real-time
       - Progress indicator showing "Question 1 of N"
       - First question card with appropriate input type
    8. Answer the first question (type some text in textarea)
    9. Wait ~1 second — verify "Draft saved" toast appears
    10. Click "Next" to advance to question 2
    11. Go back to question 1 — verify your answer is still there
    12. Refresh the page — verify answers are restored and you resume from the right question
    13. Press Ctrl+S (or Cmd+S on Mac) — verify immediate save
    14. Navigate back to tender detail page — verify "Continue Bid" button shows with Draft status
    15. Return to Dashboard — verify active bids count is now 1
    16. Try navigating away from workspace with unsaved changes — verify browser warning
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
- Tender detail page shows "Start Bid" for OPEN tenders, disabled/hidden for CLOSED/AWARDED
- Clicking "Start Bid" creates a bid and navigates to workspace
- Bid workspace shows questions, timer, progress, auto-save
- Returning to tender detail shows "Continue Bid" with status
- Dashboard shows active bids count
- Full round-trip: tender -> start bid -> answer questions -> auto-save -> refresh -> answers persist
</verification>

<success_criteria>
- "Start Bid" / "Continue Bid" actions work on tender detail page
- Dashboard reflects active bids count
- Complete workflow verified by human: tender -> bid -> Q&A -> auto-save -> resume
</success_criteria>

<output>
After completion, create `.planning/phases/04-bid-workspace/04-03-SUMMARY.md`
</output>
